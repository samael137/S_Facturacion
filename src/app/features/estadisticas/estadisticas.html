<div class="estadisticas-container">
  <!-- Header -->
  <div class="page-header">
    <div>
      <h1>Estadísticas</h1>
      <p>Análisis y métricas de tu negocio</p>
    </div>
  </div>

  <!-- Error -->
  <div class="alert alert-error" *ngIf="error()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"></circle>
      <line x1="12" y1="8" x2="12" y2="12"></line>
      <line x1="12" y1="16" x2="12.01" y2="16"></line>
    </svg>
    {{ error() }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading()" class="loading-container">
    <div class="spinner-large"></div>
    <p>Cargando estadísticas...</p>
  </div>

  <!-- Contenido -->
  <div *ngIf="!loading()" class="content">

    <!-- Métricas Principales -->
    <div class="metrics-grid">
      <div class="metric-card metric-primary">
        <div class="metric-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="metric-content">
          <div class="metric-label">Ingresos Totales</div>
          <div class="metric-value">{{ formatearMoneda(totalIngresos()) }}</div>
          <div class="metric-meta">Facturas pagadas</div>
        </div>
      </div>

      <div class="metric-card metric-success">
        <div class="metric-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
            <line x1="16" y1="2" x2="16" y2="6"></line>
            <line x1="8" y1="2" x2="8" y2="6"></line>
            <line x1="3" y1="10" x2="21" y2="10"></line>
          </svg>
        </div>
        <div class="metric-content">
          <div class="metric-label">Mes Actual</div>
          <div class="metric-value">{{ formatearMoneda(ingresosMesActual()) }}</div>
          <div class="metric-meta">{{ facturasPagadas() }} facturas pagadas</div>
        </div>
      </div>

      <div class="metric-card metric-warning">
        <div class="metric-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="metric-content">
          <div class="metric-label">Por Cobrar</div>
          <div class="metric-value">{{ formatearMoneda(montoPorCobrar()) }}</div>
          <div class="metric-meta">{{ facturasPendientes() }} pendientes</div>
        </div>
      </div>

      <div class="metric-card metric-info">
        <div class="metric-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        </div>
        <div class="metric-content">
          <div class="metric-label">Clientes</div>
          <div class="metric-value">{{ totalClientes() }}</div>
          <div class="metric-meta">Promedio: {{ formatearMoneda(promedioFactura()) }}</div>
        </div>
      </div>
    </div>

    <div class="two-column-layout">
      <div class="left-column">

        <!-- Gráfico de Ingresos por Mes -->
        <div class="card">
          <div class="card-header">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="20" x2="18" y2="10"></line>
                <line x1="12" y1="20" x2="12" y2="4"></line>
                <line x1="6" y1="20" x2="6" y2="14"></line>
              </svg>
              Ingresos por Mes
            </h2>
          </div>
          <div class="card-content">
            <div class="chart-container" *ngIf="estadisticasPorMes().length > 0">
              <div class="bar-chart">
                <div *ngFor="let stat of estadisticasPorMes()" class="bar-column">
                  <div class="bar-tooltip">
                    <strong>{{ formatearMoneda(stat.ingresos) }}</strong>
                    <span>{{ stat.facturas }} facturas</span>
                  </div>
                  <div class="bar" [style.height.%]="getAlturaGrafico(stat.ingresos)">
                    <div class="bar-value">{{ formatearMoneda(stat.ingresos) }}</div>
                  </div>
                  <div class="bar-label">{{ stat.mes }}</div>
                </div>
              </div>
            </div>
            <div class="empty-state-small" *ngIf="estadisticasPorMes().length === 0">
              <p>No hay datos suficientes para mostrar</p>
            </div>
          </div>
        </div>

        <!-- Top 5 Clientes -->
        <div class="card">
          <div class="card-header">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="8.5" cy="7" r="4"></circle>
                <polyline points="17 11 19 13 23 9"></polyline>
              </svg>
              Top 5 Clientes
            </h2>
          </div>
          <div class="card-content">
            <div class="top-clientes-list" *ngIf="topClientes().length > 0">
              <div *ngFor="let cliente of topClientes(); let i = index" class="top-cliente-item">
                <div class="ranking-number">{{ i + 1 }}</div>
                <div class="cliente-info">
                  <div class="cliente-nombre">{{ cliente.nombre }}</div>
                  <div class="cliente-meta">{{ cliente.cantidadFacturas }} facturas</div>
                </div>
                <div class="cliente-monto">{{ formatearMoneda(cliente.totalFacturado) }}</div>
              </div>
            </div>
            <div class="empty-state-small" *ngIf="topClientes().length === 0">
              <p>No hay datos de clientes disponibles</p>
            </div>
          </div>
        </div>

      </div>

      <div class="right-column">

        <!-- Distribución de Estados -->
        <div class="card">
          <div class="card-header">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 2v10l6 3"></path>
              </svg>
              Estado de Facturas
            </h2>
          </div>
          <div class="card-content">
            <div class="estados-stats" *ngIf="facturas().length > 0">
              <div class="estado-item estado-pagada">
                <div class="estado-info">
                  <div class="estado-icon">✓</div>
                  <div>
                    <div class="estado-label">Pagadas</div>
                    <div class="estado-count">{{ facturasPagadas() }}</div>
                  </div>
                </div>
                <div class="estado-barra">
                  <div class="barra-fill" [style.width.%]="calcularPorcentaje(facturasPagadas(), facturas().length)"></div>
                </div>
                <div class="estado-porcentaje">{{ calcularPorcentaje(facturasPagadas(), facturas().length).toFixed(0) }}%</div>
              </div>

              <div class="estado-item estado-pendiente">
                <div class="estado-info">
                  <div class="estado-icon">⏱</div>
                  <div>
                    <div class="estado-label">Pendientes</div>
                    <div class="estado-count">{{ facturasPendientes() }}</div>
                  </div>
                </div>
                <div class="estado-barra">
                  <div class="barra-fill" [style.width.%]="calcularPorcentaje(facturasPendientes(), facturas().length)"></div>
                </div>
                <div class="estado-porcentaje">{{ calcularPorcentaje(facturasPendientes(), facturas().length).toFixed(0) }}%</div>
              </div>

              <div class="estado-item estado-vencida">
                <div class="estado-info">
                  <div class="estado-icon">⚠</div>
                  <div>
                    <div class="estado-label">Vencidas</div>
                    <div class="estado-count">{{ facturasVencidas() }}</div>
                  </div>
                </div>
                <div class="estado-barra">
                  <div class="barra-fill" [style.width.%]="calcularPorcentaje(facturasVencidas(), facturas().length)"></div>
                </div>
                <div class="estado-porcentaje">{{ calcularPorcentaje(facturasVencidas(), facturas().length).toFixed(0) }}%</div>
              </div>
            </div>
            <div class="empty-state-small" *ngIf="facturas().length === 0">
              <p>No hay facturas registradas</p>
            </div>
          </div>
        </div>

        <!-- Facturas Recientes -->
        <div class="card">
          <div class="card-header">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
              </svg>
              Facturas Recientes
            </h2>
          </div>
          <div class="card-content">
            <div class="facturas-list" *ngIf="facturasRecientes().length > 0">
              <div *ngFor="let factura of facturasRecientes()" class="factura-item" [routerLink]="['/facturas/detalle', factura.id]">
                <div class="factura-info">
                  <div class="factura-numero">{{ factura.numeroFactura }}</div>
                  <div class="factura-cliente">{{ factura.clienteNombre }}</div>
                  <div class="factura-fecha">{{ formatearFecha(factura.fecha) }}</div>
                </div>
                <div class="factura-right">
                  <div class="factura-monto">{{ formatearMoneda(factura.total) }}</div>
                  <span class="badge" [ngClass]="getEstadoClass(factura.estado)">
                    {{ getEstadoTexto(factura.estado) }}
                  </span>
                </div>
              </div>
            </div>
            <div class="empty-state-small" *ngIf="facturasRecientes().length === 0">
              <p>No hay facturas recientes</p>
            </div>
          </div>
        </div>

        <!-- Próximas a Vencer -->
        <div class="card" *ngIf="facturasProximasVencer().length > 0">
          <div class="card-header">
            <h2>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
              </svg>
              Próximas a Vencer (7 días)
            </h2>
          </div>
          <div class="card-content">
            <div class="facturas-list">
              <div *ngFor="let factura of facturasProximasVencer()" class="factura-item alerta" [routerLink]="['/facturas/detalle', factura.id]">
                <div class="factura-info">
                  <div class="factura-numero">{{ factura.numeroFactura }}</div>
                  <div class="factura-cliente">{{ factura.clienteNombre }}</div>
                  <div class="factura-fecha">Vence: {{ formatearFecha(factura.fechaVencimiento) }}</div>
                </div>
                <div class="factura-monto">{{ formatearMoneda(factura.total) }}</div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>